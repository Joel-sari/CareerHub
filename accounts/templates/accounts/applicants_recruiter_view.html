{% extends "base.html" %}
{% block content %}

<!-- HORIZONTAL SCROLL WRAPPER -->
<div class="flex gap-10 overflow-x-auto w-full px-12 py-10">

    <!-- ================= BACKLOG ================= -->
    <div class="w-[450px] min-h-[800px] shrink-0 flex flex-col rounded-[35px]
                border border-black/30 bg-white shadow-sm p-6"
         ondrop="drop(event)" ondragover="allowDrop(event)" data-status="applied">

        <h2 class="text-2xl font-semibold text-[#243251] mb-4">Backlog</h2>
        <div class="border-b mb-4"></div>

        {% for app in backlog %}
        <div draggable="true" ondragstart="drag(event)"
             data-id="{{ app.id }}"
             class="p-4 mb-4 bg-gray-50 rounded-xl shadow cursor-move group relative">

            <!-- ADDED pointer-events-none -->
            <div class="pointer-events-none">
                <a href="{% url 'candidate_profile' app.applicant.id %}">
                    <p class="font-semibold text-lg">{{ app.applicant.username }}</p>
                    <p class="text-sm text-gray-600">{{ app.job.title }}</p>
                    <span class="status-label text-xs text-blue-600 font-medium">Applied</span>
                </a>
            </div>

            <!-- NO ACTION BUTTONS HERE -->
        </div>
        {% empty %}
        <p class="text-gray-400 text-sm text-center">No applicants yet.</p>
        {% endfor %}
    </div>


    <!-- ================= REVIEW ================= -->
    <div class="w-[450px] min-h-[800px] shrink-0 flex flex-col rounded-[35px]
                border border-black/30 bg-white shadow-sm p-6"
         ondrop="drop(event)" ondragover="allowDrop(event)" data-status="review">

        <h2 class="text-2xl font-semibold text-[#243251] mb-4">In Review</h2>
        <div class="border-b mb-4"></div>

        {% for app in review %}
        <div draggable="true" ondragstart="drag(event)"
             data-id="{{ app.id }}"
             class="p-4 mb-4 bg-gray-50 rounded-xl shadow cursor-move group relative">

            <div class="pointer-events-none">
                <a href="{% url 'candidate_profile' app.applicant.id %}">
                    <p class="font-semibold text-lg">{{ app.applicant.username }}</p>
                    <p class="text-sm text-gray-600">{{ app.job.title }}</p>
                    <span class="status-label text-xs text-yellow-600 font-medium">In Review</span>
                </a>
            </div>

            <!-- NO ACTION BUTTONS HERE -->
        </div>
        {% endfor %}
    </div>


    <!-- ================= CLOSED ================= -->
    <div class="w-[450px] min-h-[800px] shrink-0 flex flex-col rounded-[35px]
                border border-black/30 bg-white shadow-sm p-6"
         ondrop="drop(event)" ondragover="allowDrop(event)" data-status="closed">

        <h2 class="text-2xl font-semibold text-[#243251] mb-4">Closed</h2>
        <div class="border-b mb-4"></div>

        {% for app in Closed %}
        <div draggable="true" ondragstart="drag(event)"
             data-id="{{ app.id }}"
             class="p-4 mb-4 bg-gray-50 rounded-xl shadow cursor-move group relative">

            <div class="pointer-events-none">
                <a href="{% url 'candidate_profile' app.applicant.id %}">
                    <p class="font-semibold text-lg">{{ app.applicant.username }}</p>
                    <p class="text-sm text-gray-600">{{ app.job.title }}</p>
                    <span class="status-label text-xs text-gray-600 font-medium">Closed</span>
                </a>
            </div>

        </div>
        {% endfor %}
    </div>


    <!-- ================= HIRED ================= -->
    <div class="w-[450px] min-h-[800px] shrink-0 flex flex-col rounded-[35px] border border-black/30 bg-white shadow-sm p-6"
         ondrop="drop(event)" ondragover="allowDrop(event)" data-status="hired">

        <h2 class="text-2xl font-semibold text-[#243251] mb-4">Hired</h2>
        <div class="border-b mb-4"></div>

        {% for app in Hired %}
        <div draggable="true"
             ondragstart="drag(event)"
             data-id="{{ app.id }}"
             class="p-4 mb-4 bg-gray-50 rounded-xl shadow cursor-move">

            <div class="pointer-events-none">
                <a href="{% url 'candidate_profile' app.applicant.id %}">
                    <p class="font-semibold text-lg">{{ app.applicant.username }}</p>
                    <p class="text-sm text-gray-600">{{ app.job.title }}</p>
                    <span class="status-label text-xs text-green-600 font-medium">Hired</span>
                </a>
            </div>

            <!-- ACTION BUTTONS ONLY IN CLOSED COLUMN -->
            <div class="absolute right-2 bottom-2 opacity-0 group-hover:opacity-100 transition">
                <button onclick="updateFinalDecision('{{ app.id }}', 'hired')"
                        class="bg-green-500 text-white px-3 py-1 rounded text-xs mr-2">
                    Hired
                </button>

                <button onclick="updateFinalDecision('{{ app.id }}', 'rejected')"
                        class="bg-red-500 text-white px-3 py-1 rounded text-xs">
                    Reject
                </button>
            </div>
        </div>
        {% endfor %}
    </div>

</div>


<!-- RETURN BUTTON -->
<div class="flex justify-center mt-12 mb-6">
    <a href="{% url 'recruiter_dashboard' %}"
       class="bg-[#42547c] text-white px-10 py-3 rounded-full border border-[#2b3853]
              hover:bg-[#2b3853] transition">
       Return to Dashboard
    </a>
</div>


<!-- ========================================================= -->
<!-- DRAG & DROP + FINAL DECISION SCRIPT                       -->
<!-- ========================================================= -->

<script>

function allowDrop(ev) { ev.preventDefault(); }

function drag(ev) {
    ev.dataTransfer.setData("id", ev.currentTarget.getAttribute("data-id"));
}

function drop(ev) {
    ev.preventDefault();

    // Always use the COLUMN, not child text
    let column = ev.currentTarget;

    let appId = ev.dataTransfer.getData("id");
    let newStatus = column.getAttribute("data-status");

    let card = document.querySelector(`[data-id='${appId}']`);
    column.appendChild(card);

    const label = card.querySelector('.status-label');
    if (label) {
        if (newStatus === 'applied') {
            label.textContent = 'Applied';
            label.className = 'status-label text-xs font-medium text-blue-600';
        } else if (newStatus === 'review') {
            label.textContent = 'In Review';
            label.className = 'status-label text-xs font-medium text-yellow-600';
        } else if (newStatus === 'closed') {
            label.textContent = 'Closed';
            label.className = 'status-label text-xs font-medium text-gray-600';
        } else if (newStatus === 'hired') {
            label.textContent = 'Hired';
            label.className = 'status-label text-xs font-medium text-green-600';
        }
    }

    fetch(`/accounts/recruiter/applicant/${appId}/update-status/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": getCookie("csrftoken"),
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: `status=${newStatus}`
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

{% endblock %}
