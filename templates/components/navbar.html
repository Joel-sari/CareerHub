{% load static %}

<!-- templates/components/navbar.html -->
<nav class="w-full h-[60px] flex items-center justify-between bg-[#42547b] px-6 shadow-md z-50">

  <!-- Left: Logo -->
  <div class="flex items-center gap-1">
    <a href="{% if user.role == 'job_seeker' %}{% url 'jobseeker_dashboard' %}
             {% else %}{% url 'recruiter_dashboard' %}{% endif %}"
       class="flex items-center gap-1">

      <span class="ml-2 bg-gradient-to-b from-[#EFCE63] to-[#BD9B2E] bg-clip-text text-transparent font-bold text-xl tracking-tight">
        Career
      </span>
      <span class="ml-1 bg-gradient-to-b from-white to-[#A6A6A6] bg-clip-text text-transparent font-bold text-xl tracking-tight">
        Hub
      </span>

    </a>
  </div>

  <!-- Right: Icons -->
  <div class="flex items-center gap-6 relative">

    {% if user.is_authenticated %}
      {% if user.role == 'job_seeker' %}
        <a href="{% url 'jobseeker_dashboard' %}"
           class="w-6 h-6 opacity-80 hover:opacity-100 transition-opacity">
          <img src="{% static 'images/icon_dashboard.png' %}" />
        </a>
      {% else %}
        <a href="{% url 'recruiter_dashboard' %}"
           class="w-6 h-6 opacity-80 hover:opacity-100 transition-opacity">
          <img src="{% static 'images/icon_dashboard.png' %}" />
        </a>
      {% endif %}

      <a href="{% url 'messaging:inbox' %}"
         class="w-6 h-6 opacity-80 hover:opacity-100 transition-opacity">
        <img src="{% static 'images/icon_messages.png' %}" />
      </a>
    {% endif %}

    <!-- Notifications -->
    <div class="relative">
      <button id="notifications-toggle"
              class="w-6 h-6 opacity-80 hover:opacity-100 transition-opacity">
        <img src="{% static 'images/icon_notifications.png' %}" />
      </button>

      {% if unread_notification_total|default:unread_message_count > 0 %}
      <span
        class="absolute -top-1 -right-1 bg-red-600 text-white text-[0.6rem] font-bold rounded-full px-1.5 py-0.5"
>
      {{ unread_notification_total|default:unread_message_count }}
      </span>
      {% endif %}


      <!-- Dropdown panel for unread messages -->
      <div
        id="notifications-panel"
        class="hidden absolute right-0 mt-2 w-80 bg-white text-[#233250] rounded-lg shadow-lg border border-[#2b3853]/20 z-[999999]"
      >
        <div class="px-4 py-2 border-b border-gray-200/70">
          <p class="font-semibold text-sm">Notifications</p>
        </div>

        <div class="max-h-80 overflow-y-auto">
          {% if unread_job_notifications or unread_message_previews %}
            {% if unread_job_notifications %}
              <p class="px-4 pt-3 pb-1 text-[0.75rem] font-semibold text-gray-500 uppercase tracking-wide">
                Jobs near you
              </p>
              {% for notif in unread_job_notifications %}
                <a
                  href="{% url 'jobs:job_detail' notif.job.id %}?notif_id={{ notif.id }}"
                  class="block px-4 py-3 hover:bg-gray-50 border-b border-gray-200/70 last:border-b-0"
                >
                  <p class="text-xs text-gray-500">
                    {{ notif.created_at|date:"M d, H:i" }}
                  </p>
                  <p class="text-sm">
                    {{ notif.text }}
                  </p>
                </a>
              {% endfor %}
            {% endif %}

            {% if unread_message_previews %}
              <p class="px-4 pt-3 pb-1 text-[0.75rem] font-semibold text-gray-500 uppercase tracking-wide">
                Messages
              </p>
              {% for msg in unread_message_previews %}
                <a
                  href="{% url 'messaging:thread' msg.conversation.pk %}"
                  class="block px-4 py-3 hover:bg-gray-50 border-b border-gray-200/70 last:border-b-0"
                >
                  <p class="text-xs text-gray-500">
                    From {{ msg.sender.get_full_name|default:msg.sender.username }} ·
                    {{ msg.created_at|date:"M d, H:i" }}
                  </p>
                  <p class="text-sm truncate">{{ msg.body }}</p>
                </a>
              {% endfor %}
            {% endif %}
          {% else %}
            <p class="px-4 py-3 text-sm text-gray-500">No new notifications.</p>
          {% endif %}
        </div>

        <div class="px-4 py-2 border-t border-gray-200/70 flex items-center justify-between">
          <form method="post" action="{% url 'messaging:notifications_mark_all_read' %}">
            {% csrf_token %}
            <button
              type="submit"
              class="text-xs font-semibold text-gray-500 hover:text-gray-700 hover:underline"
            >
              Mark all read
            </button>
          </form>

          <a
            href="{% url 'messaging:inbox' %}"
            class="text-xs font-semibold text-blue-600 hover:underline"
          >
            View all messages
          </a>
        </div>

      </div>
    </div>

    <button id="profile-btn"
        class="w-8 h-8 rounded-full overflow-hidden border-2 border-[#efce63] bg-[#d9d9d9]">

    {% if user.role == "job_seeker" and user.jobseeker.profile_picture %}
        <img src="{{ user.jobseeker.profile_picture.url }}" class="w-full h-full object-cover">

    {% elif user.role == "recruiter" and user.recruiter.profile_picture %}
        <img src="{{ user.recruiter.profile_picture.url }}" class="w-full h-full object-cover">

    {% else %}
        <img src="{% static 'images/icon_profile.png' %}" class="w-full h-full object-cover">
    {% endif %}

</button>
    </div>

  </div>
</nav>

<!-- Profile HUD -->
<div id="profile-hud"
     style="opacity: 0; pointer-events: none"
     class="fixed top-[70px] right-6 w-80 bg-white border border-[#2b3853]/40 rounded-lg shadow-xl p-5 z-[999999] transition-opacity">

  <div class="flex items-center gap-4 mb-4">

    <!-- Profile Image -->
    <div class="w-12 h-12 rounded-full overflow-hidden border-2 border-[#efce63] bg-gray-200">

    {% if user.role == "job_seeker" and user.jobseeker.profile_picture %}
        <img src="{{ user.jobseeker.profile_picture.url }}" class="w-full h-full object-cover">

    {% elif user.role == "recruiter" and user.recruiter.profile_picture %}
        <img src="{{ user.recruiter.profile_picture.url }}" class="w-full h-full object-cover">

    {% else %}
        <img src="{% static 'images/icon_profile.png' %}" class="w-full h-full object-cover">
    {% endif %}
</div>

    <!-- Name + username + email -->
    <div class="flex flex-col leading-tight">

      <!-- Full Name -->
      <p class="font-bold text-base text-[#233250]">
        {{ user.jobseeker.full_name|default:user.username }}
      </p>

      <!-- Username (ALWAYS display) -->
      <p class="text-sm text-gray-500 -mt-0.5">
        @{{ user.username }}
      </p>

      <!-- Email -->
      <p class="text-sm text-gray-600">
        {{ user.email }}
      </p>

    </div>

  </div>

  <hr class="my-3" />

  <ul class="space-y-2">
    {% if user.role == 'job_seeker' %}
      <li><a href="{% url 'jobseeker_onboarding' %}" class="font-medium hover:text-[#42547b]">Edit Profile</a></li>
      <li><a href="{% url 'jobs:job_list' %}" class="font-medium hover:text-[#42547b]">View Jobs</a></li>

    {% elif user.role == 'recruiter' %}
    <li>
      <a
        href="{% url 'recruiter_onboarding' %}"
        class="block font-medium text-[#233250] hover:text-[#42547b] transition-colors"
      >
        Edit Profile
      </a>
    </li>
    <li>
      <a
        href="{% url 'recruiter_preferences' %}"
        class="block font-medium text-[#233250] hover:text-[#42547b] transition-colors"
      >
        Candidate Preferences
      </a>
    </li>
    <li>
      <a
        href="{% url 'jobs:my_list' %}"
        class="block font-medium text-[#233250] hover:text-[#42547b] transition-colors"
      >
        My Job Listings
      </a>
    </li>
    <li>
      <!-- Messages link -->
      <a
        href="{% url 'messaging:inbox' %}"
        class="block font-medium text-[#233250] hover:text-[#42547b] transition-colors"
      >
        Messages
      </a>
    </li>
    {% endif %}
  </ul>

  <hr class="my-3" />

  <form method="post" action="{% url 'logout' %}">
    {% csrf_token %}
    <button type="submit" class="text-red-600 font-semibold hover:text-red-700">Log Out</button>
  </form>

</div>

<script>
  (function attachProfileHud() {
    // Try to get elements immediately
    const btn = document.getElementById("profile-btn");
    const hud = document.getElementById("profile-hud");

    // If either element is missing, wait until DOM is ready
    if (!btn || !hud) {
      document.addEventListener("DOMContentLoaded", function () {
        const lateBtn = document.getElementById("profile-btn");
        const lateHud = document.getElementById("profile-hud");
        if (!lateBtn || !lateHud) return; // still nothing, bail out silently

        initProfileHud(lateBtn, lateHud);
      }, { once: true });
      return;
    }

    // If we're here, elements exist now – wire them up immediately
    initProfileHud(btn, hud);
  })();

  function initProfileHud(btn, hud) {
    let isOpen = false;

    function showHud() {
      hud.style.opacity = "1";
      hud.style.pointerEvents = "auto";
      isOpen = true;
    }

    function hideHud() {
      hud.style.opacity = "0";
      hud.style.pointerEvents = "none";
      isOpen = false;
    }

    function toggleHud(event) {
      event.stopPropagation();
      if (isOpen) {
        hideHud();
      } else {
        showHud();
      }
    }

    // Click on avatar toggles the HUD
    btn.addEventListener("click", toggleHud);

    // Click anywhere else on the page closes the HUD if open
    document.addEventListener("click", function (event) {
      if (
        isOpen &&
        !hud.contains(event.target) &&
        !btn.contains(event.target)
      ) {
        hideHud();
      }
    });
  }
</script>