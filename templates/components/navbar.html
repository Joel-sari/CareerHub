{% load static %}

<!-- templates/components/navbar.html -->
<nav class="w-full h-[60px] flex items-center justify-between bg-[#42547b] px-6 shadow-md z-50">

  <!-- Left: Logo -->
  <div class="flex items-center gap-1">
    <a href="{% if user.role == 'job_seeker' %}{% url 'jobseeker_dashboard' %}
             {% else %}{% url 'recruiter_dashboard' %}{% endif %}"
       class="flex items-center gap-1">

      <span class="ml-2 bg-gradient-to-b from-[#EFCE63] to-[#BD9B2E] bg-clip-text text-transparent font-bold text-xl tracking-tight">
        Career
      </span>
      <span class="ml-1 bg-gradient-to-b from-white to-[#A6A6A6] bg-clip-text text-transparent font-bold text-xl tracking-tight">
        Hub
      </span>

    </a>
  </div>

  <!-- Right: Icons -->
  <div class="flex items-center gap-6 relative">

    {% if user.is_authenticated %}
      {% if user.role == 'job_seeker' %}
        <a href="{% url 'jobseeker_dashboard' %}"
           class="w-6 h-6 opacity-80 hover:opacity-100 transition-opacity">
          <img src="{% static 'images/icon_dashboard.png' %}" />
        </a>
      {% else %}
        <a href="{% url 'recruiter_dashboard' %}"
           class="w-6 h-6 opacity-80 hover:opacity-100 transition-opacity">
          <img src="{% static 'images/icon_dashboard.png' %}" />
        </a>
      {% endif %}

      <a href="{% url 'messaging:inbox' %}"
         class="w-6 h-6 opacity-80 hover:opacity-100 transition-opacity">
        <img src="{% static 'images/icon_messages.png' %}" />
      </a>
    {% endif %}

    <!-- Notifications -->
    <div class="relative">
      <button id="notifications-toggle"
              class="w-6 h-6 opacity-80 hover:opacity-100 transition-opacity">
        <img src="{% static 'images/icon_notifications.png' %}" />
      </button>

      {% if unread_message_count > 0 %}
      <span class="absolute -top-1 -right-1 bg-red-600 text-white text-[0.6rem] font-bold rounded-full px-1 py-0.5">
        {{ unread_message_count }}
      </span>
      {% endif %}

      <div id="notifications-panel"
           class="hidden absolute right-0 mt-2 w-80 bg-white text-[#233250] rounded-lg shadow-lg border border-[#2b3853]/20 z-[999999]">

        <div class="px-4 py-2 border-b border-gray-300/70">
          <p class="font-semibold text-sm">Notifications</p>
        </div>

        <div class="max-h-80 overflow-y-auto">
          {% if unread_message_previews %}
            {% for msg in unread_message_previews %}
            <a href="{% url 'messaging:thread' msg.conversation.pk %}"
               class="block px-4 py-3 hover:bg-gray-50 border-b border-gray-200/70">
              <p class="text-xs text-gray-500">
                From {{ msg.sender.username }} Â· {{ msg.created_at|date:"M d, H:i" }}
              </p>
              <p class="text-sm truncate">{{ msg.body }}</p>
            </a>
            {% endfor %}
          {% else %}
            <p class="px-4 py-3 text-sm text-gray-500">No new messages.</p>
          {% endif %}
        </div>

        <div class="px-4 py-2 border-t border-gray-200/70 text-right">
          <a href="{% url 'messaging:inbox' %}"
             class="text-xs font-semibold text-blue-600 hover:underline">View all messages</a>
        </div>

      </div>
    </div>

    <!-- Profile Button -->
    <div class="relative">
      <button id="profile-btn"
              class="w-8 h-8 rounded-full bg-[#d9d9d9] overflow-hidden border-2 border-[#efce63]">
        
        {% if user.is_authenticated and user.role == 'job_seeker' and user.jobseeker.profile_picture %}
          <img src="{{ user.jobseeker.profile_picture.url }}" class="w-full h-full object-cover" />
        {% else %}
          <img src="{% static 'images/icon_profile.png' %}" class="w-full h-full object-cover" />
        {% endif %}
      
      </button>
    </div>

  </div>
</nav>

<!-- SINGLE, CORRECT HUD (KEEP THIS ONE) -->
<div id="profile-hud"
     style="opacity: 0; pointer-events: none"
     class="fixed top-[70px] right-6 w-80 bg-white border border-[#2b3853]/40 rounded-lg shadow-xl p-5 z-[999999] transition-opacity">

  <div class="flex items-center gap-4 mb-4">

    <!-- Profile Image -->
    <div class="w-12 h-12 rounded-full overflow-hidden border-2 border-[#efce63] bg-gray-200">
      {% if user.is_authenticated and user.role == "job_seeker" and user.jobseeker.profile_picture %}
        <img src="{{ user.jobseeker.profile_picture.url }}" class="w-full h-full object-cover" />
      {% else %}
        <img src="{% static 'images/icon_profile.png' %}" class="w-full h-full object-cover" />
      {% endif %}
    </div>

    <div>
      <p class="font-bold">{{ user.get_full_name|default:user.username }}</p>
      <p class="text-gray-600 text-sm">{{ user.email }}</p>
    </div>

  </div>

  <hr class="my-3" />

  <ul class="space-y-2">
    {% if user.role == 'job_seeker' %}
      <li><a href="{% url 'jobseeker_onboarding' %}" class="font-medium hover:text-[#42547b]">Edit Profile</a></li>
      <li><a href="{% url 'jobs:job_list' %}" class="font-medium hover:text-[#42547b]">View Jobs</a></li>

    {% elif user.role == 'recruiter' %}
      <li><a href="{% url 'recruiter_onboarding' %}" class="font-medium hover:text-[#42547b]">Edit Profile</a></li>
      <li><a href="{% url 'jobs:my_list' %}" class="font-medium hover:text-[#42547b]">My Job Listings</a></li>
      <li><a href="{% url 'messaging:inbox' %}" class="font-medium hover:text-[#42547b]">Messages</a></li>
    {% endif %}

    <li class="text-gray-400">Notifications</li>
  </ul>

  <hr class="my-3" />

  <form method="post" action="{% url 'logout' %}">
    {% csrf_token %}
    <button type="submit" class="text-red-600 font-semibold hover:text-red-700">Log Out</button>
  </form>

</div>

<!-- JS -->
<script>
  (function () {
    const btn = document.getElementById("profile-btn");
    const hud = document.getElementById("profile-hud");

    if (!btn || !hud) return;

    function toggleHud(e) {
      e.stopPropagation();
      const hidden = hud.style.opacity === "0" || hud.style.opacity === "";
      hud.style.opacity = hidden ? "1" : "0";
      hud.style.pointerEvents = hidden ? "auto" : "none";
    }

    btn.addEventListener("click", toggleHud);

    document.addEventListener("click", (e) => {
      if (!hud.contains(e.target) && !btn.contains(e.target)) {
        hud.style.opacity = "0";
        hud.style.pointerEvents = "none";
      }
    });
  })();
</script>
