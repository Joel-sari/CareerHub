{% load static %}
<!-- templates/components/navbar.html -->
<nav
  class="w-full h-[60px] flex items-center justify-between bg-[#42547b] px-6 shadow-md z-50"
>
  <!-- Left: Logo -->
  <div class="flex items-center gap-1">
    <a
      href="{% if user.role == 'job_seeker' %}{% url 'jobseeker_dashboard' %}{% elif user.role == 'recruiter' %}{% url 'recruiter_dashboard' %}{% endif %}"
      class="flex items-center gap-1"
    >
      <span
        class="ml-2 bg-gradient-to-b from-[#EFCE63] to-[#BD9B2E] bg-clip-text text-transparent font-bold text-xl tracking-tight"
      >
        Career
      </span>
      <span
        class="ml-1 bg-gradient-to-b from-white to-[#A6A6A6] bg-clip-text text-transparent font-bold text-xl tracking-tight"
      >
        Hub
      </span>
    </a>
  </div>

  <!-- Right: Icons -->
  <div class="flex items-center gap-6 relative">
    {% if user.role == 'job_seeker' %}
    <a
      href="{% url 'jobseeker_dashboard' %}"
      aria-label="Job Seeker Dashboard"
      class="w-6 h-6 opacity-80 hover:opacity-100 transition-opacity"
    >
      <img
        src="{% static 'images/icon_dashboard.png' %}"
        alt="Dashboard"
        class="w-full h-full"
      />
    </a>
    {% elif user.role == 'recruiter' %}
    <a
      href="{% url 'recruiter_dashboard' %}"
      aria-label="Recruiter Dashboard"
      class="w-6 h-6 opacity-80 hover:opacity-100 transition-opacity"
    >
      <img
        src="{% static 'images/icon_dashboard.png' %}"
        alt="Dashboard"
        class="w-full h-full"
      />
    </a>
    {% endif %} {% if user.is_authenticated %}
    <a
      href="{% url 'messaging:inbox' %}"
      aria-label="Messages"
      class="w-6 h-6 opacity-80 hover:opacity-100 transition-opacity"
    >
      <!-- You can swap this image for a chat bubble icon if you have one -->
      <img
        src="{% static 'images/icon_messages.png' %}"
        alt="Messages"
        class="w-full h-full"
      />
    </a>
    {% endif %}

    <div class="relative">
      <button
        id="notifications-toggle"
        type="button"
        aria-label="Notifications"
        class="w-6 h-6 opacity-80 hover:opacity-100 transition-opacity"
      >
        <img
          src="{% static 'images/icon_notifications.png' %}"
          alt="Notifications"
          class="w-full h-full"
        />
      </button>

      {% if unread_message_count > 0 %}
      <!-- red badge in top-right corner of bell -->
      <span
        class="absolute -top-1 -right-1 bg-red-600 text-white text-[0.6rem] font-bold rounded-full px-1.5 py-0.5"
      >
        {{ unread_message_count }}
      </span>
      {% endif %}

      <!-- Dropdown panel for unread messages -->
      <div
        id="notifications-panel"
        class="hidden absolute right-0 mt-2 w-80 bg-white text-[#233250] rounded-lg shadow-lg border border-[#2b3853]/20 z-[999999]"
      >
        <div class="px-4 py-2 border-b border-gray-200/70">
          <p class="font-semibold text-sm">Notifications</p>
        </div>

        <div class="max-h-80 overflow-y-auto">
          {% if unread_message_previews %}
          <!---place holder -->
          {% for msg in unread_message_previews%}
          <a
            href="{% url 'messaging:thread' msg.conversation.pk %}"
            class="block px-4 py-3 hover:bg-gray-50 border-b last:border-b-0 border-gray-200/70"
          >
            <p class="text-xs text-gray-500">
              From {{ msg.sender.get_full_name|default:msg.sender.username }} ·
              {{ msg.created_at|date:"M d, H:i" }}
            </p>
            <p class="text-sm truncate">{{ msg.body }}</p>
          </a>
          {% endfor %}
          <!---place holder -->
          {% else %}
          <p class="px-4 py-3 text-sm text-gray-500">No new messages.</p>
          {% endif %}
        </div>

        <div class="px-4 py-2 border-t border-gray-200/70 text-right">
          <a
            href="{% url 'messaging:inbox' %}"
            class="text-xs font-semibold text-blue-600 hover:underline"
          >
            View all messages
          </a>
        </div>
      </div>
    </div>

    <!-- Profile Button -->
    <div class="relative">
      <button
        id="profile-btn"
        type="button"
        class="w-8 h-8 rounded-full bg-[#d9d9d9] overflow-hidden border-2 border-[#efce63] hover:ring-2 hover:ring-[#efce63] transition-all"
      >
        <img
          src="{% static 'images/icon_profile.png' %}"
          alt="User"
          class="w-full h-full object-cover"
        />
      </button>
    </div>
  </div>
</nav>

<!-- Profile HUD (dropdown) -->
<div
  id="profile-hud"
  style="opacity: 0; pointer-events: none"
  class="fixed top-[70px] right-6 w-80 bg-white border border-[#2b3853]/40 rounded-lg shadow-xl p-5 z-[999999] transition-opacity duration-200"
>
  <!-- User Info -->
  <div class="flex items-center gap-4 mb-4">
    <div class="w-12 h-12 bg-gray-300 rounded-full"></div>
    <div>
      <p class="font-bold text-base text-[#233250]">
        {{ user.get_full_name|default:user.username }}
      </p>
      <p class="text-sm text-gray-600">{{ user.email }}</p>
    </div>
  </div>

  <hr class="my-3 border-gray-300/40" />

  <!-- Role-based Links -->
  <ul class="space-y-2">
    {% if user.role == 'job_seeker' %}
    <li>
      <a
        href="{% url 'jobseeker_onboarding' %}"
        class="block font-medium text-[#233250] hover:text-[#42547b] transition-colors"
        >Edit Profile</a
      >
    </li>
    <li>
      <a
        href="{% url 'jobs:job_list' %}"
        class="block font-medium text-[#233250] hover:text-[#42547b] transition-colors"
        >View Jobs</a
      >
    </li>
    {% elif user.role == 'recruiter' %}
    <li>
      <a
        href="{% url 'recruiter_onboarding' %}"
        class="block font-medium text-[#233250] hover:text-[#42547b] transition-colors"
      >
        Edit Profile
      </a>
    </li>
    <li>
      <a
        href="{% url 'recruiter_preferences' %}"
        class="block font-medium text-[#233250] hover:text-[#42547b] transition-colors"
      >
        Candidate Preferences
      </a>
    </li>
    <li>
      <a
        href="{% url 'jobs:my_list' %}"
        class="block font-medium text-[#233250] hover:text-[#42547b] transition-colors"
      >
        My Job Listings
      </a>
    </li>
    <li>
      <!-- Messages link -->
      <a
        href="{% url 'messaging:inbox' %}"
        class="block font-medium text-[#233250] hover:text-[#42547b] transition-colors"
      >
        Messages
      </a>
    </li>
    {% endif %}
  </ul>

  <hr class="my-3 border-gray-300/40" />

  <!-- Logout -->
  <form method="post" action="{% url 'logout' %}">
    {% csrf_token %}
    <button
      type="submit"
      class="block w-full text-left text-red-600 font-semibold hover:text-red-700 transition-colors"
    >
      Log Out
    </button>
  </form>
</div>

<!-- JS - Inline style ensures immediate availability -->
<script>
  (function () {
    // Wait until the DOM is fully loaded and parsed
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initHud);
    } else {
      initHud(); // Already loaded
    }

    function initHud() {
      const profileBtn = document.getElementById("profile-btn");
      const profileHud = document.getElementById("profile-hud");
      if (!profileBtn || !profileHud) return;

      let isAnimating = false;

      function toggleHud(e) {
        e.stopPropagation();
        if (isAnimating) return;
        isAnimating = true;

        const isHidden =
          profileHud.style.opacity === "0" || profileHud.style.opacity === "";

        if (isHidden) {
          profileHud.style.opacity = "1";
          profileHud.style.pointerEvents = "auto";
        } else {
          profileHud.style.opacity = "0";
          profileHud.style.pointerEvents = "none";
        }

        setTimeout(() => (isAnimating = false), 250);
      }

      function closeHud() {
        if (isAnimating) return;
        profileHud.style.opacity = "0";
        profileHud.style.pointerEvents = "none";
      }

      // ✅ attach normally (bubble phase)
      profileBtn.addEventListener("click", toggleHud);

      document.addEventListener("click", (e) => {
        const isVisible = profileHud.style.opacity === "1";
        if (
          isVisible &&
          !profileHud.contains(e.target) &&
          !profileBtn.contains(e.target)
        ) {
          closeHud();
        }
      });

      // Optional smooth transition guarantee
      profileHud.style.transition = "opacity 0.25s ease";
    }
  })();
  // ================================
  // Notifications dropdown toggle
  // ================================
  const notifToggle = document.getElementById("notifications-toggle");
  const notifPanel = document.getElementById("notifications-panel");

  if (notifToggle && notifPanel) {
    notifToggle.addEventListener("click", function (e) {
      e.stopPropagation();
      const isHidden = notifPanel.classList.contains("hidden");
      if (isHidden) {
        notifPanel.classList.remove("hidden");
      } else {
        notifPanel.classList.add("hidden");
      }
    });

    // Close notifications if clicking outside
    document.addEventListener("click", function (e) {
      const clickInsidePanel = notifPanel.contains(e.target);
      const clickOnToggle = notifToggle.contains(e.target);
      if (!clickInsidePanel && !clickOnToggle) {
        if (!notifPanel.classList.contains("hidden")) {
          notifPanel.classList.add("hidden");
        }
      }
    });
  }
</script>
