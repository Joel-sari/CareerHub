{% extends "base.html" %}
{% block content %}

<!-- ================= HEADER ================= -->
<div class="flex items-center justify-between mb-8">
  <h2 class="text-3xl font-semibold text-[#243251]">
    Find Your Next Opportunity
  </h2>

  {% if user.is_authenticated and user.role == 'recruiter' %}
    <a href="{% url 'jobs:create' %}" class="btn-primary">
      + Create Job Listing
    </a>
  {% endif %}
</div>

<!-- ================= FILTER FORM ================= -->
<form method="get" class="mb-6 p-5 border border-gray-200 rounded-2xl bg-gray-50 shadow-sm">
  <div class="flex flex-wrap items-center gap-4">
    <!-- Job Title -->
    <input type="text" name="title" placeholder="Title" value="{{ request.GET.title }}"
           class="border border-gray-300 rounded-full px-4 py-2 w-28 focus:ring-2 focus:ring-[#42547c] outline-none" />

    <!-- Skills -->
    <input type="text" name="skills" placeholder="Skills" value="{{ request.GET.skills }}"
           class="border border-gray-300 rounded-full px-4 py-2 w-28 focus:ring-2 focus:ring-[#42547c] outline-none" />

    <!-- Salary Range -->
    <input type="number" name="salary_min" placeholder="Min $" value="{{ request.GET.salary_min }}"
           class="border border-gray-300 rounded-full px-4 py-2 w-32 focus:ring-2 focus:ring-[#42547c] outline-none" />
    <input type="number" name="salary_max" placeholder="Max $" value="{{ request.GET.salary_max }}"
           class="border border-gray-300 rounded-full px-4 py-2 w-32 focus:ring-2 focus:ring-[#42547c] outline-none" />

    <!-- Work Type -->
    <select name="remote"
            class="border border-gray-300 rounded-full px-3 py-2 w-28 focus:ring-2 focus:ring-[#42547c] outline-none">
      <option value="">Any</option>
      <option value="true" {% if request.GET.remote == 'true' %}selected{% endif %}>Remote</option>
      <option value="false" {% if request.GET.remote == 'false' %}selected{% endif %}>On-site</option>
    </select>

    <!-- Visa Sponsorship -->
    <select name="visa"
            class="border border-gray-300 rounded-full px-3 py-2 w-28 focus:ring-2 focus:ring-[#42547c] outline-none">
      <option value="">Any</option>
      <option value="true" {% if request.GET.visa == 'true' %}selected{% endif %}>Visa</option>
      <option value="false" {% if request.GET.visa == 'false' %}selected{% endif %}>No Visa</option>
    </select>

    <!-- Search Button -->
    <button type="submit" class="btn-primary text-[16px] px-6 py-2">
      üîç Search
    </button>
  </div>
</form>

{% if user.is_authenticated and user.role == 'job_seeker' %}
<!-- ================= LOCATION TOOLBAR ================= -->
<div class="flex items-center justify-between mb-8">
  <div class="flex items-center gap-6">
    <button type="button"
            onclick="getUserLocation()"
            class="btn-secondary px-10 py-3 text-[17px] font-semibold flex items-center gap-2 min-w-[250px] justify-center">
       <span>Find Jobs Near Me</span>
    </button>

    <label for="radius" class="text-gray-600 text-[15px]">Radius:</label>
    <select id="radius"
            onchange="getUserLocation()"
            class="border border-gray-300 rounded-full px-4 py-2 text-[15px] focus:ring-2 focus:ring-[#42547c] outline-none">
      <option value="5" {% if request.GET.radius == '5' %}selected{% endif %}>5 mi</option>
      <option value="10" {% if request.GET.radius == '10' or not request.GET.radius %}selected{% endif %}>10 mi</option>
      <option value="25" {% if request.GET.radius == '25' %}selected{% endif %}>25 mi</option>
      <option value="50" {% if request.GET.radius == '50' %}selected{% endif %}>50 mi</option>
    </select>
  </div>
</div>
{% endif %}

<!-- ================= JOB SECTIONS ================= -->
<div class="space-y-12">
  <!-- Nearby Jobs -->
  <section>
    <h3 class="text-xl font-semibold text-[#243251] mb-4">Jobs Near You</h3>

    {% if nearby_jobs %}
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      {% for job in nearby_jobs %}
      <div class="border border-gray-200 rounded-2xl p-6 shadow-sm hover:shadow-md transition bg-white">
        <h4 class="text-lg font-semibold text-[#243251]">
          <a href="{% url 'jobs:job_detail' job.pk %}" class="hover:underline">{{ job.title }}</a>
        </h4>
        <p class="text-gray-600">{{ job.company }} ‚Äî {{ job.location }}</p>
        <p class="text-sm text-gray-500 mb-2">{{ job.distance_miles }} miles away</p>

        {% if user.role == 'job_seeker' %}
          {% if job.applied %}
            <span class="text-green-600 text-sm font-medium">‚úì Already Applied</span>
          {% else %}
            <a href="{% url 'jobs:apply_job' job.pk %}" class="btn-primary text-[15px] px-6 py-2 mt-2 inline-block">
              Apply
            </a>
          {% endif %}
        {% endif %}
      </div>
      {% endfor %}
    </div>
    {% else %}
    <p class="text-gray-500 mt-2">No jobs found within your selected radius.</p>
    {% endif %}
  </section>

  <!-- All Jobs -->
  <section>
    <h3 class="text-xl font-semibold text-[#243251] mb-4">All Available Jobs</h3>

    {% if all_jobs %}
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      {% for job in all_jobs %}
      <div class="border border-gray-200 rounded-2xl p-6 shadow-sm hover:shadow-md transition bg-white">
        <h4 class="text-lg font-semibold text-[#243251]">
          <a href="{% url 'jobs:job_detail' job.pk %}" class="hover:underline">{{ job.title }}</a>
        </h4>
        <p class="text-gray-600">{{ job.company }} ‚Äî {{ job.location }}</p>

        {% if user.role == 'job_seeker' %}
          {% if job.applied %}
            <span class="text-green-600 text-sm font-medium">‚úì Already Applied</span>
          {% else %}
            <a href="{% url 'jobs:apply_job' job.pk %}" class="btn-primary text-[15px] px-6 py-2 mt-2 inline-block">
              Apply
            </a>
          {% endif %}
        {% endif %}
      </div>
      {% endfor %}
    </div>
    {% else %}
    <p class="text-gray-500">No available job postings right now.</p>
    {% endif %}
  </section>
</div>

<script>
  function getUserLocation() {
    const radius = document.getElementById("radius").value || 10;
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          const baseUrl = window.location.pathname;
          const params = new URLSearchParams({ lat, lng, radius });
          window.location.href = `${baseUrl}?${params.toString()}`;
        },
        () => alert("Unable to retrieve your location.")
      );
    } else {
      alert("Geolocation not supported in this browser.");
    }
  }
</script>

{% endblock %}
